+++
mt_entry_id = 499
date = "2011-01-08T23:42:45+09:00"
title = "Perlで出退勤管理などする。"
categories = []

+++

勤め先での出退勤管理は、毎日の出退勤時刻をExcelファイルに入力し、一ヶ月分をまとめて提出という、だいぶざっくりとした感じで行われております。毎日会社についたら最初に時刻をExcelに入力して保存、帰る前に時刻をExcelに入力して保存、とやっていれば良いのですが、ブログソフトを開発しているのに三日とブログを書き続ける事もできないプロの三日坊主の僕の事、Excelを入力して保存というタスクを日課とする事は遂にできませんでした。

月末になるとあちこちに空欄の残るExcelシートをなんとか本来あるべき姿にするという作業に悶絶することになります。TwitterやFoursquareなどのログから記憶を呼び起こして事なきを得る場合もありますが、もちろんそれですべてをまかなえる訳ではありません。最終手段はPCのシステムログです。WindowsXPを使っていましたので、コントロールパネル >> 管理ツール >> イベントビューワー >> システムとかその辺を探して自分の行動をトレースします。

時々、夜を徹して働き続けたという記録が残っています。さすがに完徹したなら覚えているはずですが記憶にはございません。おそらくWindowsがシャットダウンに失敗したのでしょう。そんなときは本当に記憶だけを頼りに入力する事になります。自分の記憶なんてあてになりません。多分、嘘の時間を書いた事が何回もあります。バレてないと良いのですが。

先々月、MacBook Air(以下MBA)が発売されて割とすぐに飛びつきました。買ってすぐに会社に持っていって見せびらかしたところ、すでに結構な数のMBAが周りでは稼働しており、自慢するという目標は達成できませんでした。そのうえ、そのままMBAで作業していたら、快適すぎてWindowsマシンに戻れなくなり、毎日MBAを持って家と会社を往復するという生活になってしまいました。悪い事は重なるもので、家に持って帰るとなるとシャットダウンもしませんので、system.logから就業時間を推察するという技も使えなくなります。

僕は悩みました。このままではMBAの快適さと引き換えに、今まで以上にとても適当な出退勤表を提出することになり、申し訳なさのあまり死んでしまう。<!--more-->Solution 1: MBAの接続先のSSIDを監視して会社への到着を知る

そもそもMBAと常に行動をともにしているのだから、出勤するという事はMBAが会社に到着する事と同義。MBAが出勤して最初にする事と言えば、社内のネットワークに接続する事。
ならば、MBAが常に接続先のネットワークを監視して、会社のネットワークにその日最初に接続された時間と最後に接続した時間をログに残しておけば、かなり正確に出退勤の時刻を把握できるでしょう。どのネットワークに接続していたかは、無線LANのSSIDを基準に判定します。

Mac OSXでは以下のコマンドで現在の無線ネットワークのステータスを取得できます。

<pre>/System/Library/PrivateFrameworks/Apple80211.framework/Versions/A/Resources/airport -I</pre>

参考: <a href="http://unknownplace.org/memo/2009/12/03/1/">無線APによって自動でhostsを変える方法 - unknownplace.org</a>

なんかズラズラと出てくるので、パースしてSSIDを取ってきます。直近のステータスをファイルに吐いておいて、直近と実行時でSSIDに変化があったら、別途ログに吐くようなスクリプトにしたのがこちらです。cronでぶん回しておけば、何時から何時までどこのネットワークにいたのかを記録できます。

ついでに、特定のSSIDに接続された時点でやりたい事も書けます。ちょっと工夫すれば自動ライフロガーにもなります。自分はこれで、Foursquare でオフィスにチェックインをするようにしました。これで絶対にチェックイン忘れする事がなくなりました。Mayerへ一直線です。必死だな。

Solution 2: iPhoneに頼る

僕のMBAへの愛もいつしか薄れ、同伴出勤をしなくなる日が来るかもしれません。それなりに重いし。そんな時にも、iPhoneだけは傍らにいるはずです。iPhoneにもお願いして、GPSで見守ってくれたらどんなに安心できる事でしょうか。

しかしiPhoneのネイティブアプリを制作するのは骨が折れそうです。以前参加していた Developer Program も更新しなかったし。<a href="#footnote-1">*1</a>

そこで今回は、MobileMe をつかってWeb経由で現在地を取得することにします。CPANにWebService::MobileMeというのがあったので、これを使います。スクリプトにユーザー名とパスワードを書くのがイヤンな感じですが、まあ良しとします。で、latitudeとlongitudeがとれるので、あらかじめ調べておいたオフィスの現在地と一緒にGeo::Distanceに突っ込んでオフィスからの距離に変換。150mくらいの誤差が出るようなので、それ以内の距離だったら多分会社にいるでしょう。

MobileMeのAPIは

<div id="footnote-1">
Developer Programは登録しなくてもアプリのインストールは出来るらしい。この記事を半分以上書いた後に知った。

<ul>
	<li><a href="http://d.hatena.ne.jp/kumattau/20110110/1294684307">Developer 登録なしで iPhone に自作アプリをインストールする - くまったうの日記</a></li>
	<li></li>
</ul></div>