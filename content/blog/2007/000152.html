+++
mt_entry_id = 152
date = "2007-06-24T23:10:40+09:00"
title = "MT4Beta : ExtensibleArchivesを作成してみた"
categories = []

+++

MT4で追加された新機能の中には、プラグインの機能を大幅に拡張するようなものがあります。
その中でも、かなり大きな拡張要素と思われるExtensibleArchivesに挑戦してみました。

結論から言うと、最初に想像していたものとは異なる部分もあり、思うような結果が出せませんでした。<!--more-->まず、そもそもExtensibleArchivesとは何か、について説明してみます。

MTでは、いわゆる過去ログのことを、Archiveと呼びます。
Archiveは、ブログに存在するエントリーを、特定のルールに従っていくつかのグループにまとめ、各グループ毎に一つのファイルに出力するという形で実現されています。

例えば、月別アーカイブでは、2007年5月に投稿されたエントリーを集めたグループ、2007年6月に投稿されたエントリーを集めたグループ、といった形にエントリーがグループ分けされます。そして、それらグループをテンプレート(MT3.3のデフォルトでは日別テンプレート)にしたがって整形して、それぞれのファイルに出力します。ファイルは、組み合わせられたグループの数だけ出力されることになります。

同様にカテゴリーアーカイブでは、hogeカテゴリーに属するエントリーのグループ、mogeカテゴリーに属するエントリーのグループといったグループ分けを行い、それぞれのグループごとにカテゴリーテンプレートで整形してファイルに出力する、という具合です。

今までのMTでも、好きなグループ分けのルールを、好きなテンプレートと組み合わせて好きなファイルパスに出力させる事が出来る、自由度の高いシステムが採用されていました。(アーカイブ・マッピング)
しかし、その中心となるグループ分けのルールそのものは、システムに組み込みの5種類(多分)のみで、本体を改造しない限りは拡張ができませんでした。

今回MT4で追加されたExtensibleArchives機能は、このグループ分けのルールそのものをプラグインを導入することで拡張可能にするものです。
これによって、今までは出来なかったエントリーの投稿者別のアーカイブ等が作成できるようになりました。投稿者別アーカイブは現在のベータ版のデフォルトのプラグインとして同梱されていますね。

実際にプラグインをどうやって作成すればよいのか、コードとニラメッコしながら、早速、一つプラグインを作ってみました。何箇所か未解決の問題があるのですが、その辺りはMT4のリリースを待って修正したいと思います。

今回は、各エントリーのタイトルの頭文字を基準に、英和辞書風にグループ分けする「DictionaryArchive」を追加するプラグインを試作してみました。
まず、MT4のプラグインではお決まりのregistryに、サブルーチンを設定していきます。

sub init_registry {
    my $plugin = shift;
    $plugin->registry({
        archive_types => {
        'Dictionary' =>
        ArchiveType(
            name => 'MyNameIsDictionary',
            archive_label => \&dictionary_archive_label,
            archive_file => \&dictionary_archive_file,
            archive_title => \&dictionary_archive_title,
            archive_group_iter => \&dictionary_group_iter,
            archive_group_entries => \&dictionary_group_entries,
            default_archive_templates => [
                ArchiveFileTemplate(label => 'headletter_group.html',
                                    template => '%a/%f',
                                    default => 1),
            ],
            dynamic_support => 0,
            author_based => 1,
        ),
    }});
}

ArchiveTypeサブルーチンに必要なパラメータを引渡し、新しいArchiveTypeオブジェクトを作成してregistryに登録します。

name
ちょっとどこで使われるのか分かりませんでした。

archive_label
アーカイブを管理画面から指定するような場合に表示される文字列です。文字列を返すサブルーチンのリファレンスを指定するようです。

archive_file
アーカイブを構築する際のファイル名を決定するサブルーチンのリファレンスを指定します。

archive_title
個々のアーカイブ・ページのタイトルを決定するサブルーチンのリファレンスを指定します。

archive_group_iter
このアーカイブの各ページの情報を順に返すイテレータとして動作するクロージャを返すサブルーチンのリファレンスを指定します。ああややこしい。

archive_group_entries
個々のページで表示するべきエントリーのオブジェクトの配列を返すサブルーチンのリファレンスを指定します。

default_archive_templates
アーカイブ・マッピング画面で表示されるデフォルトのファイルパス生成ルールを指定します。

author_based
真を指定すると、author archiveとしての振る舞いをします。他にdate_based、category_based、entry_basedを指定できます。重複しても構いません。

後は、よく分からないので省略。
archive_labelは静的な文字列を返すだけなので置いといて、ここまでで4つ、サブルーチンのリファレンスを指定しました。この4つのサブルーチンが、アーカイブの振る舞いを決定することになります。他はおまけです。


では、この4つのサブルーチンが、どのようなタイミングでどのように呼び出され、そして何を行えばよいのか見ていきます。

これらのサブルーチン群は、大きく以下のふたつのケースで呼び出されます。

アーカイブページを再構築する場合
インデックステンプレートなど、アーカイブ以外の箇所で「MTArchive*」タグを使って参照される場合

まず、アーカイブページを再構築する場合ですが、最初にMTは、再構築の対象となる


MTArchivePrevious/MTArchiveNextの出力をコントロール出来ない
