+++
mt_entry_id = 458
date = "2009-06-22T00:24:49+09:00"
title = "registryメソッド三態"
categories = []

+++

プラグイン作る時には必ずお世話になるregistryメソッドについて。備忘録。

<h3>レジストリはハッシュツリーである</h3>
レジストリとは、まあwindowsのアレと同じで、MovableTypeがシステム設定を管理するための巨大なハッシュツリーです。レジストリがあらゆる設定を一元管理する事で、プラグイン経由で各種の情報を登録してシステムの挙動を変更したり、プラグインの動作を別のプラグインから操作したり、といった事が容易に実現できます。MT4の中核をなす概念です。

<h3>レジストリはハッシュツリーでは無い</h3>
さて、先ほど「レジストリは巨大なハッシュツリーである」と書きました。内部表現としてはその通り、PerlのHASHをツリー状にくみ上げたものです。が、セッター/ゲッターであるregistryメソッドを正しく使えば、以下のような機能の恩恵にあずかる事が出来ます。

<h4>labelのtranslate</h4>
registryメソッド経由で値が取得される場合、そのハッシュツリー以下に「label」というキーで文字列が登録されていれば、その値は自動的にtranslateされます。

<h4>接ぎ木</h4>
ハッシュツリー内に、外部のハッシュツリーとみなせる値があった場合、自動的に展開されます。
具体的には以下の3つのパターンが該当します。
<ul>
	<li>yamlファイルへのpathとみなせる文字列</li>
	<li>$Component::Module::subroutineという形式で書かれた、MTの特定のＣｏｍｐｏｎｅｎｔに紐づけられたサブルーチン名。</li>
	<li>CODEREF</li>
</ul>

<h4>pluginへのリファレンスの自動補完</h4>
取得した部分木がハッシュだった場合、その子供である値がハッシュリファレンスならば、そこにキー「plugin」が追加され、その値を提供したComponent自身へのリファレンスが値にセットされます。

setterとしての使い方
$some_component->registry(
    'path' => 'to' => 'registry' => 'key' =>
    {
        set => 'this',
        'as'  => 'hashref',
    }    
);

my $ref_buz = MT->registry('foo','bar','buz');

さて、ここからが本題。
MTクラスのregistryメソッド
基本的にgetterとしてのみ動作します。
MT::Componentクラスのインスタンスメソッド
MT::Componentクラスのクラスメソッド