+++
mt_entry_id = 399
date = "2008-03-02T15:38:49+09:00"
title = "Writting Custom Button Plugins"
categories = ["mtplugins"]

+++

Custom Editor Button 2 用のプラグインの作成方法を解説します。
<!--more-->プラグインを作成することで、CustomEditorButton2に任意のボタンを追加できます。
プラグインは通常の Movable Type のプラグインとして作成します。
といっても、ボタンの画像と簡単なyamlファイルを用意するだけですので、MTのプラグイン作成の知識はほとんど必要ありません。
ここでは、ボタンをクリックすると「Hello!」という文字列を追加するボタンを例として、作成の流れを見ていきます。
まずはyamlファイルの作成から始めましょう。

<h3>yamlファイルを作成する</h3>

<h4>プラグイン情報を書く</h4>

適当なテキストエディタで、新規ファイルを作成します。
最初に書くのは、プラグインとしての情報です。ここで書いた内容が、MTの管理画面のプラグイン一覧に表示されます。

<pre class="code">name: Hello Button
id: Hello Button
key: HelloButton
author_link: http://blog.aklaswad.com/
author_name: Aklaswad
description: Say hello.
version: 0.1
plugin_link: http://blog.aklaswad.com/mtplugins/hellobutton/</pre>

あちこち省略しても問題ありませんが、せっかくだからきちんと書いておきましょう。

<h4>ボタンを追加する</h4>

次に、ボタンを追加します。

<pre class="code">buttons:
    hello:
        image: hello.png
        title: say hello!
        code: |
            function ceb_hello ( text ) {
                return 'Hello! ' + text;
            }</pre>

一つのプラグインで、複数のボタンを追加することも出来ます。

<h4>ボタンの名前を指定する</h4>

<pre class="code">buttons:
    hello:</pre>

この部分です。ここからボタンの指定が続きますよ、という指定の「butons:」の次の行に、半角スペース4つ分字下げしてボタンの名前を指定します。今回は「hello」という名前にします。
名前には半角スペースなどを含めないようにしてください。

<h4>image: ボタンの画像を指定する</h4>

用意した画像ファイルのファイル名を指定します。詳しくは後述します。

<h4>title: ボタンの動作の説明を書いておきましょう</h4>

ボタンの上にマウスのカーソルを置いたときに、ここに指定したものが表示されます。

<h4>code: javascriptでボタンの動作を作る</h4>

javascriptでコードの動作を指定します。字下げ幅をきちんと守るようにしてください。
ここからは、少しだけjavascriptの知識が必要となります。
ボタンがクリックされたときには、先ほど決めたボタンの名前に、「ceb_」という接頭辞をくっつけた
関数がコールされます。
この関数に対して、現在エディタ上で選択している文字列が第一引数として渡されます。
ほとんどの場合、この引数「text」に対して何らかの加工をすることが目的となるでしょう。

加工した結果の文字列を、関数の戻り値として返却してください。エディタの選択部分に挿入されます。

<pre class="code">            function ceb_hello ( text ) {
                return 'Hello! ' + text;
            }</pre>

「code」ブロックには、呼び出される関数以外の関数も記述できます。

<h4>改行して保存する</h4>

yamlファイルの仕様で、最後の行の後ろに改行が必要です。忘れないようにしてください。
編集が完了したら、改行コードを「LF」にして保存します。名前は「config.yaml」としてください。

<h3>ボタンの画像を作成する</h3>

<form mt:asset-id="66" class="mt-enclosure mt-enclosure-image" style="display: inline;"><img alt="hello.png" src="http://blog.aklaswad.com/images/hello.png" width="22" height="22" class="mt-image-left" style="float: left; margin: 0 20px 20px 0;" /></form>画像は22px x 22px の大きさで作成します。画像ファイルの種類は、ブラウザが表示可能な種類なら何でもOKです。

もし、画像を用意するのが面倒なら、単にテキストを表示させることも出来ます。
「image」は指定せず、代わりに「face_text」という項目に、表示させたいテキストを指定してください。あまり長いと、ボタンからはみ出してしまうので気をつけましょう。

<pre class="code">buttons:
    bye:
        face_text: bye
        title: say bye!
        code: |
            function ceb_bye ( text ) {
                return 'bye ' + text;
            }</pre>

<h3>作成したプラグインのインストール</h3>

MTのpluginsディレクトリに、作成したプラグイン用の名前のディレクトリを作成し、その中に先ほど作成したyamlファイルを「config.yaml」という名前で保存します。
同様に、MTのmt-staticディレクトリにもpluginsというディレクトリがありますので、その中にプラグインの名前のディレクトリを作成し、画像ファイルを置きます。

ファイルの設置が完了したら、プラグイン一覧画面を開いて、インストールを確認してみましょう。

<form mt:asset-id="65" class="mt-enclosure mt-enclosure-image" style="display: inline;"><img alt="hello_pluginconfig.png" src="http://blog.aklaswad.com/images/hello_pluginconfig.png" width="222" height="136" class="mt-image-center" style="text-align: center; display: block; margin: 0 auto 20px;" /></form>

成功です!
 ･･･もしプラグインが一覧に表示されていない場合は、アップロード先のディレクトリが正しいか見てみましょう。
また、以下のようなエラーが出て管理画面にアクセスできなくなってしまった場合

<blockquote>Got an error: Error reading /home/foo/public_html/cgi-bin/mt/plugins/HelloButton/config.yaml: Stream does not end with newline character (YAML_PARSE_ERR_NO_FINAL_NEWLINE) at lib/MT/Component.pm line 150.</blockquote>

yamlファイルの改行コードが間違っている場合や、yaml形式の字下げがおかしくなっている場合、最後の改行が足りない場合が考えられます。修正してみてください。

<form mt:asset-id="67" class="mt-enclosure mt-enclosure-image" style="display: inline;"><img alt="hello_on_editor.png" src="http://blog.aklaswad.com/images/hello_on_editor.png" width="121" height="67" class="mt-image-left" style="float: left; margin: 0 20px 20px 0;" /></form>さて、無事にインストールできたら、早速ブログ記事編集画面を開いてみましょう。自動的にボタンが追加されているはずです。<br clear="both" />

<h3>作成したプラグインを配布する</h3>

<form mt:asset-id="63" class="mt-enclosure mt-enclosure-image" style="display: inline;"><img alt="hello_directory_tree.png" src="http://blog.aklaswad.com/images/hello_directory_tree.png" width="167" height="140" class="mt-image-left" style="float: left; margin: 0 20px 20px 0;" /></form>作成したプラグインを配布する場合、MTの一般的なディレクトリ構成に併せてパッケージングしましょう。画像のようになると思います。<br clear="both" />

完成したプラグインはこちらになります。

<ul>
	<li><form mt:asset-id="68" class="mt-enclosure mt-enclosure-file" style="display: inline;"><a href="http://blog.aklaswad.com/mtplugins/HelloButton.zip">HelloButton.zip</a></form></li>
</ul>

<h3>その他、細かい仕様</h3>

<h4>コールバックに渡される引数</h4>
選択文字列「text」のあとに、ヘルパーオブジェクトが渡されます。

<pre class="code">function ceb_foo(text, args) {
    //do something
}</pre>

このヘルパーオブジェクトから、いくつかのプロパティやメソッドを利用できます。
現在用意されているのは以下の物です。

<dl>
<dt>innerHTML()</dt>
<dd>選択範囲をHTML文字列で返します。
第一引数の「text」では、エディタがiframeで表示されているときも、見えている文字列の取得になりますが、innerHTML()を利用すると、iframeでの選択範囲のマークアップを含めた内容をHTMLで取得することが出来ます。
</dd>
<dt>iframe</dt>
<dd>エディタがiframeで表示されているかをbool値で確認できます。</dd>
<dt>editor</dt>
<dd>MT.App.editorオブジェクトの参照を取得できます。</dd>
</dl>

<h4>コールバックの戻り値について</h4>
コールバック関数が未定義値を返却した場合、CustomEditorButtonは、エディタに対して一切の変更を加えません。